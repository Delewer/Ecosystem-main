{% extends 'base.html' %}

{% block title %}Catalog lecții · UnITex{% endblock %}

{% block content %}
<section class="rounded-4 bg-white shadow-sm p-4 p-lg-5 mb-4">
    <div class="row g-4 align-items-center">
        <div class="col-lg-7">
            <h1 class="display-6 fw-bold text-primary">Explorator de lecții</h1>
            <p class="lead text-muted mb-4">Alege lecțiile potrivite nivelului tău, câștigă puncte de experiență și descoperă recomandări personalizate.</p>
            <div class="d-flex flex-wrap gap-4">
                <div>
                    <span class="d-block text-uppercase small text-muted">Progres</span>
                    <span class="fs-3 fw-bold">{{ progress.percent|default:0 }}%</span>
                </div>
                <div>
                    <span class="d-block text-uppercase small text-muted">Lecții finalizate</span>
                    <span class="fs-3 fw-bold">{{ progress.completed|default:0 }}/{{ progress.total|default:0 }}</span>
                </div>
                <div>
                    <span class="d-block text-uppercase small text-muted">Insigne evidențiate</span>
                    <div class="d-flex gap-2 mt-1">
                        {% for badge in highlighted_badges %}
                            <span class="badge" style="background: {{ badge.badge.color }}33; color: {{ badge.badge.color }};">
                                <i class="fa {{ badge.badge.icon }} me-1"></i>{{ badge.badge.name }}
                            </span>
                        {% empty %}
                            <span class="text-muted small">Încă nu ai insigne, dar aventura abia începe!</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-5">
            <form method="get" class="card border-0 shadow-sm">
                <div class="card-body">
                    <h2 class="h5 mb-3">Filtrează și caută</h2>
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label" for="q">Căutare</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
                                <input type="search" id="q" name="q" value="{{ filters.query }}" class="form-control" placeholder="Titlu, subiect, idee cheie…">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="subject">Subiect</label>
                            <select id="subject" name="subject" class="form-select">
                                <option value="">Toate</option>
                                {% for subject in subjects %}
                                    <option value="{{ subject.id }}" {% if filters.subject == subject.id|stringformat:'s' %}selected{% endif %}>{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="difficulty">Nivel</label>
                            <select id="difficulty" name="difficulty" class="form-select">
                                <option value="">Oricare</option>
                                {% for value, label in difficulty_choices %}
                                    <option value="{{ value }}" {% if filters.difficulty == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="1" id="upcoming" name="upcoming" {% if filters.upcoming %}checked{% endif %}>
                                <label class="form-check-label" for="upcoming"><i class="fa-solid fa-calendar-day me-1 text-primary"></i>Doar lecțiile viitoare</label>
                            </div>
                        </div>
                        <div class="col-12 d-flex justify-content-between">
                            <a class="btn btn-outline-secondary" href="{% url 'estudy:lessons_list' %}">Resetează</a>
                            <button class="btn btn-primary" type="submit">Aplică filtre</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</section>

<section class="lesson-blocks-wrapper mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h4 mb-0">Trasee și blocuri tematice</h2>
        <span class="badge bg-primary-subtle text-primary">{{ lessons|length }} rezultate</span>
    </div>
    {% if lesson_blocks %}
        <div class="lesson-blocks d-flex flex-column gap-5">
            {% for block in lesson_blocks %}
                <article class="lesson-block card shadow-sm border-0" id="block-{{ block.slug }}">
                    <div class="lesson-block__header card-body d-flex flex-column flex-lg-row justify-content-between gap-4">
                        <div class="lesson-block__meta flex-grow-1">
                            <div class="d-flex flex-wrap gap-2 mb-2">
                                {% if block.type == 'path' %}
                                    <span class="badge bg-primary-subtle text-primary"><i class="fa-solid fa-compass me-1"></i>Parcurs tematic</span>
                                    <span class="badge bg-info-subtle text-info"><i class="fa-solid fa-gauge-high me-1"></i>{{ block.difficulty_label }}</span>
                                {% else %}
                                    <span class="badge bg-secondary-subtle text-secondary"><i class="fa-solid fa-book me-1"></i>Subiect</span>
                                {% endif %}
                                {% if block.total %}
                                    <span class="badge bg-success-subtle text-success"><i class="fa-solid fa-circle-check me-1"></i>{{ block.completed }}/{{ block.total }} finalizate</span>
                                {% endif %}
                            </div>
                            <h3 class="lesson-block__title mb-1">{{ block.title }}</h3>
                            <p class="lesson-block__description text-muted mb-0">{{ block.description|default:"Acest traseu adună lecțiile potrivite pentru nivelul tău." }}</p>
                        </div>
                        <div class="lesson-block__progress text-center text-lg-start">
                            <span class="lesson-block__progress-label text-uppercase small text-muted d-block">Progres bloc</span>
                            <div class="progress progress-thin bg-light my-2">
                                <div class="progress-bar bg-primary" style="width: {{ block.progress_percent }}%;" aria-valuenow="{{ block.progress_percent }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="lesson-block__cta d-flex flex-column gap-2">
                                {% if block.next_lesson %}
                                    <a class="btn btn-primary btn-sm align-self-lg-start" href="{% url 'estudy:lesson_detail' slug=block.next_lesson.slug %}">
                                        {% if block.next_lesson.is_completed %}<i class="fa-solid fa-arrow-rotate-right me-1"></i>Revezi{% elif block.next_lesson.is_accessible %}<i class="fa-solid fa-play me-1"></i>Continuă parcursul{% else %}<i class="fa-solid fa-flag-checkered me-1"></i>Start bloc{% endif %}
                                    </a>
                                {% endif %}
                                <span class="small text-muted">{{ block.progress_percent }}% complet · {{ block.completed }} / {{ block.total }} lecții</span>
                            </div>
                        </div>
                    </div>
                    <div class="lesson-block__lessons pb-4 px-3 px-lg-4">
                        <div class="row g-4">
                            {% for lesson in block.lessons %}
                                {% with palette=lesson.difficulty_palette %}
                                <div class="col-md-6 col-xl-4">
                                    {% with completed=lesson.is_completed accessible=lesson.is_accessible sequence=lesson.sequence %}
                                    <article class="lesson-card lesson-card--grid{% if completed %} lesson-card--completed{% elif not accessible %} lesson-card--locked{% endif %}">
                                        <div class="lesson-card__statusbar">
                                            {% if sequence %}
                                                <span class="lesson-card__sequence badge bg-dark bg-opacity-25 text-white"><i class="fa-solid fa-route me-1"></i>Pas {{ sequence.index }} din {{ sequence.total }}</span>
                                            {% endif %}
                                            <span class="lesson-card__state badge {% if completed %}bg-success-subtle text-success{% elif accessible %}bg-primary-subtle text-primary{% else %}bg-secondary-subtle text-secondary{% endif %}">
                                                {% if completed %}
                                                    <i class="fa-solid fa-check me-1"></i>Finalizat
                                                {% elif accessible %}
                                                    <i class="fa-solid fa-unlock-keyhole me-1"></i>Pregătit
                                                {% else %}
                                                    <i class="fa-solid fa-lock me-1"></i>Blocat
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="lesson-card__image" style="background: {{ palette.bg }};">
                                            <div class="p-3 text-white d-flex justify-content-between">
                                                <span class="badge bg-dark bg-opacity-25">{{ lesson.subject.name }}</span>
                                                <span class="fs-3">{{ palette.emoji }}</span>
                                            </div>
                                        </div>
                                        <div class="lesson-card__body">
                                            <h3 class="h5 mb-1"><a {% if accessible or completed %}href="{% url 'estudy:lesson_detail' slug=lesson.slug %}"{% else %}href="#" class="stretched-link disabled" aria-disabled="true"{% endif %}>{{ lesson.title }}</a></h3>
                                            <p class="text-muted small mb-3">{{ lesson.excerpt|default:"Pregătește-te pentru o aventură de învățare!" }}</p>
                                            <div class="d-flex flex-wrap gap-2 small">
                                                <span class="badge rounded-pill bg-primary-subtle text-primary"><i class="fa-solid fa-trophy me-1"></i>{{ lesson.xp_reward }} XP</span>
                                                <span class="badge rounded-pill bg-secondary-subtle text-secondary"><i class="fa-solid fa-gauge-high me-1"></i>{{ lesson.get_difficulty_display }}</span>
                                                <span class="badge rounded-pill bg-success-subtle text-success"><i class="fa-solid fa-clock me-1"></i>{{ lesson.duration_minutes }} min</span>
                                            </div>
                                        </div>
                                        <div class="lesson-card__footer d-flex justify-content-between align-items-center">
                                            <span class="small text-muted"><i class="fa-solid fa-calendar-day me-1"></i>{{ lesson.date|date:"d MMM" }}</span>
                                            {% if completed %}
                                                <a class="btn btn-sm btn-outline-success" href="{% url 'estudy:lesson_detail' slug=lesson.slug %}"><i class="fa-solid fa-rotate-left me-1"></i>Reia</a>
                                            {% elif accessible %}
                                                <a class="btn btn-sm btn-primary" href="{% url 'estudy:lesson_detail' slug=lesson.slug %}"><i class="fa-solid fa-play me-1"></i>Continuă</a>
                                            {% else %}
                                                <button class="btn btn-sm btn-outline-secondary" type="button" disabled><i class="fa-solid fa-lock me-1"></i>Dezblochează</button>
                                            {% endif %}
                                        </div>
                                        {% if not accessible and not completed %}
                                            <div class="lesson-card__lock">
                                                <i class="fa-solid fa-lock lesson-card__lock-icon"></i>
                                                {% if lesson.locked_reason %}
                                                    <p class="lesson-card__lock-text">Finalizează "{{ lesson.locked_reason.title }}" mai întâi pentru a continua traseul.</p>
                                                {% else %}
                                                    <p class="lesson-card__lock-text">Finalizează lecția precedentă pentru a continua.</p>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </article>
                                    {% endwith %}
                                </div>
                                {% endwith %}
                            {% endfor %}
                        </div>
                    </div>
                </article>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center py-5 bg-white rounded-4 shadow-sm">
            <h3 class="h5 mb-2">Nu am găsit lecții pentru filtrele alese.</h3>
            <p class="text-muted mb-0">Resetează filtrele sau revino curând pentru lecții noi.</p>
        </div>
    {% endif %}
</section>

<section class="row g-4 mb-5">
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0">Recomandări pentru tine</h2>
                <span class="badge bg-secondary-subtle text-secondary"><i class="fa-solid fa-sparkles me-1"></i>Personalizat</span>
            </div>
            <div class="card-body">
                {% if recommendations %}
                    <ul class="list-group list-group-flush">
                        {% for item in recommendations %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ item.lesson.title }}</strong>
                                    <div class="text-muted small">{{ item.lesson.subject.name }}</div>
                                </div>
                                <a class="btn btn-sm btn-outline-primary" href="{% url 'estudy:lesson_detail' slug=item.lesson.slug %}">Pornește</a>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted mb-0">Toate lecțiile recomandate sunt bifate! Continuă aventura în ritmul tău.</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0">Ce urmează</h2>
                <span class="badge bg-primary-subtle text-primary"><i class="fa-solid fa-calendar-check me-1"></i>Calendar</span>
            </div>
            <div class="card-body">
                {% if upcoming_lessons %}
                    <ul class="timeline list-unstyled mb-0">
                        {% for lesson in upcoming_lessons %}
                            <li class="timeline-item">
                                <div class="timeline-date">{{ lesson.date|date:"d MMM" }}</div>
                                <div class="timeline-content">
                                    <h3 class="h6 mb-1">{{ lesson.title }}</h3>
                                    <p class="text-muted small mb-1">{{ lesson.subject.name }}</p>
                                    <a class="small text-decoration-none" href="{% url 'estudy:lesson_detail' slug=lesson.slug %}">Detalii lecție</a>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted mb-0">Nu ai lecții viitoare programate. Poți alege una chiar acum!</p>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<section class="mb-5">
    <div class="card shadow-sm">
        <div class="card-header bg-white">
            <h2 class="h5 mb-0">Actualizate recent</h2>
        </div>
        <div class="card-body">
            {% if latest_lessons %}
                <div class="row g-3">
                    {% for lesson in latest_lessons %}
                        <div class="col-md-4">
                            <div class="p-3 rounded-3 border h-100">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="badge bg-info-subtle text-info"><i class="fa-solid fa-wand-magic-sparkles me-1"></i>Nou</span>
                                    <span class="small text-muted">{{ lesson.updated_at|date:"d MMM" }}</span>
                                </div>
                                <h3 class="h6 mb-1">{{ lesson.title }}</h3>
                                <p class="text-muted small mb-3">{{ lesson.subject.name }}</p>
                                <a class="btn btn-sm btn-outline-secondary" href="{% url 'estudy:lesson_detail' slug=lesson.slug %}">Vezi lecția</a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted mb-0">Momentan nu există actualizări. Revino mai târziu!</p>
            {% endif %}
        </div>
    </div>
</section>
{% endblock %}
