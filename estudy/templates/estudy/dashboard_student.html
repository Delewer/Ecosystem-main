{% extends 'base.html' %}

{% block title %}Dashboard elev · UnITex{% endblock %}

{% block content %}
<section class="dashboard-hero card shadow-lg">
    <div class="dashboard-hero__summary">
        <p class="dashboard-hero__greeting">Salut, {{ profile.display_or_username }}</p>
        <h1 class="dashboard-hero__title">Pregătit pentru o nouă aventură digitală?</h1>
        <p class="dashboard-hero__intro">Progresul tău general este de <strong>{{ progress.percent|default:0 }}%</strong>. Continuă să explorezi lecțiile, să strângi XP și să deblochezi insigne rare.</p>
        <div class="dashboard-hero__progress">
            <div class="dashboard-hero__progress-bar">
                <div class="dashboard-hero__progress-fill" style="width: {{ profile.progress_to_next_level|floatformat:0 }}%"></div>
            </div>
            <span class="dashboard-hero__progress-label">Nivel {{ profile.level }} · {{ profile.xp }} XP</span>
        </div>
        <div class="dashboard-hero__stats">
            <div class="stat-chip">
                <span class="stat-chip__label">Nivel</span>
                <span class="stat-chip__value">{{ profile.level }}</span>
            </div>
            <div class="stat-chip">
                <span class="stat-chip__label">Streak</span>
                <span class="stat-chip__value"><i class="fa-solid fa-fire me-1"></i>{{ profile.streak }} zile</span>
            </div>
            <div class="stat-chip">
                <span class="stat-chip__label">Lecții terminate</span>
                <span class="stat-chip__value">{{ progress.completed|default:0 }}/{{ progress.total|default:0 }}</span>
            </div>
        </div>
        <div class="dashboard-hero__actions">
            {% if primary_recommendation %}
                <a class="btn btn-primary" href="{% url 'estudy:lesson_detail' slug=primary_recommendation.lesson.slug %}"><i class="fa-solid fa-play me-2"></i>Continuă lecția recomandată</a>
            {% else %}
                <a class="btn btn-primary" href="{% url 'estudy:lessons_list' %}"><i class="fa-solid fa-compass me-2"></i>Descoperă lecții noi</a>
            {% endif %}
            <a class="btn btn-outline-light" href="{% url 'estudy:missions' %}"><i class="fa-solid fa-flag-checkered me-2"></i>Misiunile mele</a>
        </div>
    </div>
    <div class="dashboard-hero__badges">
        <h2 class="dashboard-hero__badges-title">Insigne evidențiate</h2>
        <div class="badge-cloud">
            {% if highlighted_badges %}
                {% for user_badge in highlighted_badges %}
                    <div class="badge-cloud__item" style="--badge-color: {{ user_badge.badge.color }};">
                        <div class="badge-cloud__icon"><i class="fa {{ user_badge.badge.icon }}"></i></div>
                        <div class="badge-cloud__meta">
                            <span class="badge-cloud__name">{{ user_badge.badge.name }}</span>
                            <span class="badge-cloud__hint">+{{ user_badge.badge.xp_reward }} XP</span>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p class="text-muted small mb-0">Adună XP completând lecții pentru a debloca primele tale insigne.</p>
            {% endif %}
        </div>
    </div>
</section>

<section class="dashboard-section">
    <div class="dashboard-grid">
        <article class="dashboard-card">
            <div class="dashboard-card__header">
                <div>
                    <h2 class="dashboard-card__title">Misiuni active</h2>
                    <p class="dashboard-card__subtitle">Completează-le astăzi pentru bonus XP.</p>
                </div>
                <a class="btn btn-sm btn-outline-primary" href="{% url 'estudy:missions' %}">Toate misiunile</a>
            </div>
            <div class="dashboard-card__body">
                {% if missions.daily %}
                    <ul class="mission-list">
                        {% for mission in missions.daily %}
                            <li class="mission-item">
                                <div class="mission-item__head">
                                    <span class="mission-chip" style="--mission-color: {{ mission.mission.color }}"><i class="fa {{ mission.mission.icon }} me-1"></i>Daily</span>
                                    <span class="mission-progress-label">{{ mission.progress }}/{{ mission.mission.target_value }}</span>
                                </div>
                                <div class="mission-item__title">{{ mission.mission.title }}</div>
                                <p class="mission-item__desc">{{ mission.mission.description }}</p>
                                <div class="progress mission-progress">
                                    <div class="progress-bar" style="width: {% widthratio mission.progress mission.mission.target_value 100 %}%"></div>
                                </div>
                                <div class="mission-item__reward"><i class="fa-solid fa-bolt me-1"></i>+{{ mission.mission.reward_points }} XP</div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted mb-0">Nu ai misiuni active. Revino mai târziu pentru provocări noi!</p>
                {% endif %}
            </div>
        </article>

        <article class="dashboard-card">
            <div class="dashboard-card__header">
                <div>
                    <h2 class="dashboard-card__title">Lecții recomandate</h2>
                    <p class="dashboard-card__subtitle">Selectate pe baza lecțiilor finalizate.</p>
                </div>
            </div>
            <div class="dashboard-card__body">
                {% if recommendations %}
                    <ul class="lesson-reco-list">
                        {% for rec in recommendations|slice:':4' %}
                            <li class="lesson-reco">
                                <div>
                                    <div class="lesson-reco__title">{{ rec.lesson.title }}</div>
                                    <div class="lesson-reco__meta">{{ rec.reason }}</div>
                                </div>
                                <a class="btn btn-sm btn-outline-primary" href="{% url 'estudy:lesson_detail' slug=rec.lesson.slug %}">Start</a>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted mb-0">Ai parcurs toate lecțiile sugerate. Alege un nou subiect!</p>
                {% endif %}
            </div>
        </article>

        <article class="dashboard-card">
            <div class="dashboard-card__header">
                <div>
                    <h2 class="dashboard-card__title">Ultimele notificări</h2>
                    <p class="dashboard-card__subtitle">Rămâi la curent cu noutățile și feedback-ul.</p>
                </div>
                <a class="btn btn-sm btn-outline-secondary" href="{% url 'estudy:notifications' %}">Toate</a>
            </div>
            <div class="dashboard-card__body">
                {% if notifications %}
                    <ul class="notification-list">
                        {% for item in notifications %}
                            <li class="notification-item">
                                <div class="notification-item__title">{{ item.title }}</div>
                                <p class="notification-item__desc">{{ item.message }}</p>
                                <span class="notification-item__time">{{ item.created_at|date:"d MMM · HH:mm" }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted mb-0">Nu există notificări noi momentan.</p>
                {% endif %}
            </div>
        </article>
    </div>
</section>

<section class="dashboard-section">
    <div class="dashboard-grid">
        <article class="dashboard-card">
            <div class="dashboard-card__header">
                <div>
                    <h2 class="dashboard-card__title">Provocări zilnice</h2>
                    <p class="dashboard-card__subtitle">Completează provocările pentru bonusuri speciale.</p>
                </div>
            </div>
            <div class="dashboard-card__body">
                {% if challenges %}
                    <ul class="challenge-list">
                        {% for challenge in challenges %}
                            <li class="challenge-item">
                                <div class="challenge-item__title">{{ challenge.title }}</div>
                                <p class="challenge-item__desc">{{ challenge.description }}</p>
                                <span class="challenge-item__time"><i class="fa-solid fa-calendar-day me-1"></i>{{ challenge.start_date|date:"d MMM" }} - {{ challenge.end_date|date:"d MMM" }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted mb-0">Nicio provocare activă acum. Reîncarcă pagina mai târziu!</p>
                {% endif %}
            </div>
        </article>

        <article class="dashboard-card">
            <div class="dashboard-card__header">
                <div>
                    <h2 class="dashboard-card__title">Clasament rapid</h2>
                    <p class="dashboard-card__subtitle">Top 5 elevi din această săptămână.</p>
                </div>
                <a class="btn btn-sm btn-outline-primary" href="{% url 'estudy:leaderboard' %}">Clasament complet</a>
            </div>
            <div class="dashboard-card__body">
                {% if leaderboard %}
                    <ul class="leaderboard-list">
                        {% for entry in leaderboard %}
                            <li class="leaderboard-item">
                                <div class="leaderboard-item__rank">#{{ entry.position }}</div>
                                <div class="leaderboard-item__user">{{ entry.username }}</div>
                                <div class="leaderboard-item__score"><i class="fa-solid fa-star"></i>{{ entry.score }}</div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted mb-0">Clasamentul se pregătește. Participă la lecții pentru a apărea aici!</p>
                {% endif %}
            </div>
        </article>

        <article class="dashboard-card">
            <div class="dashboard-card__header">
                <div>
                    <h2 class="dashboard-card__title">Proiecte recente</h2>
                    <p class="dashboard-card__subtitle">Lucrările tale și feedback-ul profesorilor.</p>
                </div>
                <a class="btn btn-sm btn-outline-secondary" href="{% url 'estudy:projects' %}">Toate proiectele</a>
            </div>
            <div class="dashboard-card__body">
                {% if recent_projects %}
                    <ul class="project-list">
                        {% for submission in recent_projects %}
                            <li class="project-item">
                                <div>
                                    <div class="project-item__title">{{ submission.project.title }}</div>
                                    <span class="project-item__status">{{ submission.get_status_display|default:"În progres" }}</span>
                                </div>
                                <span class="project-item__time">{{ submission.uploaded_at|date:"d MMM" }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted mb-0">Încă nu ai încărcat proiecte. Încearcă unul din secțiunea „Proiecte”.</p>
                {% endif %}
            </div>
        </article>
    </div>
</section>
{% endblock %}
