{% extends 'base.html' %}

{% block title %}{{ lesson.title }} · UnITex{% endblock %}

{% block content %}
<div class="lesson-page">
    <header class="lesson-banner card shadow-lg">
        <div class="lesson-banner__summary">
            <div class="lesson-pill-group">
                <span class="lesson-pill lesson-pill--difficulty"><i class="fa-solid fa-gauge-high me-1"></i>{{ lesson.get_difficulty_display }} · {{ lesson.age_label }}</span>
                <span class="lesson-pill lesson-pill--subject"><i class="fa-solid fa-book-open me-1"></i>{{ lesson.subject.name }}</span>
                <span class="lesson-pill lesson-pill--position"><i class="fa-solid fa-location-dot me-1"></i>Pas {{ lesson_position }} din {{ subject_total }}</span>
            </div>
            <h1 class="lesson-banner__title">{{ lesson.title }}</h1>
            <p class="lesson-banner__subtitle">{{ lesson.theory_intro|default:lesson.excerpt|default:"Variabilele sunt ca niște cutii cu etichetă în care păstrezi date. În această lecție le folosești prin exemple ușoare, pas cu pas." }}</p>
            {% if lesson.theory_points %}
                <ul class="hero-quicklist">
                    {% for point in lesson.theory_points %}
                        <li><i class="fa-solid fa-sparkles"></i>{{ point }}</li>
                    {% endfor %}
                </ul>
            {% else %}
                <ul class="hero-quicklist">
                    <li><i class="fa-solid fa-sparkles"></i>Folosește o variabilă pentru a păstra informații importante.</li>
                    <li><i class="fa-solid fa-repeat"></i>Rescrie valoarea atunci când povestea se schimbă.</li>
                    <li><i class="fa-solid fa-lightbulb"></i>Alege nume clare pentru ca echipa să înțeleagă rapid codul.</li>
                </ul>
            {% endif %}
            <div class="lesson-banner__actions">
                <button type="button"
                        class="btn btn-voice"
                        data-voice-button
                        data-voice-lang="ro-RO"
                        data-voice-alt-lang="ro"
                        data-voice-names="google ro-ro,microsoft andrei,microsoft alina,amazon luiza"
                        data-voice-text="{{ lesson_voice_text|default:''|escapejs }}">
                    <i class="fa-solid fa-headphones me-2"></i>Ascultă explicația
                </button>
                <button class="btn btn-soft toggle-completion"
                        data-complete-btn
                        data-label-pending='<i class="fa-regular fa-circle-check me-2"></i>Marchează reușita'
                        data-label-completed='<i class="fa-solid fa-check me-2"></i>Lecția bifată'
                        data-complete-href="{% url 'estudy:toggle_lesson_completion' slug=lesson.slug %}">
                    {% if progress and progress.completed %}<i class="fa-solid fa-check me-2"></i>Lecția bifată{% else %}<i class="fa-regular fa-circle-check me-2"></i>Marchează reușita{% endif %}
                </button>
                <a class="btn btn-outline-light" href="{% url 'estudy:lessons_list' %}"><i class="fa-solid fa-list me-2"></i>Înapoi la lecții</a>
            </div>
        </div>
        <aside class="lesson-banner__meta">
            <div class="lesson-banner__meta-grid">
                <div class="lesson-banner__meta-item">
                    <span class="lesson-banner__meta-label">Data lecției</span>
                    <span class="lesson-banner__meta-value">{{ lesson.date|date:"d MMM" }}</span>
                </div>
                <div class="lesson-banner__meta-item">
                    <span class="lesson-banner__meta-label">Durată</span>
                    <span class="lesson-banner__meta-value">{{ lesson.duration_minutes }} min</span>
                </div>
                <div class="lesson-banner__meta-item">
                    <span class="lesson-banner__meta-label">XP recompensa</span>
                    <span class="lesson-banner__meta-value">+{{ lesson.xp_reward }} XP</span>
                </div>
                <div class="lesson-banner__meta-item">
                    <span class="lesson-banner__meta-label">Stare</span>
                    <span class="lesson-banner__meta-status {% if progress and progress.completed %}is-complete{% else %}is-active{% endif %}" data-lesson-status>
                        {% if progress and progress.completed %}Finalizată{% else %}În curs{% endif %}
                    </span>
                </div>
            </div>
            <div class="lesson-banner__progress">
                <span class="lesson-banner__meta-label">Progres general</span>
                <div class="lesson-banner__progress-bar">
                    <div class="lesson-banner__progress-fill" data-progress-bar data-progress-initial="{{ global_progress.percent|default:0 }}"></div>
                </div>
                <span class="lesson-banner__progress-foot"><span data-progress-completed>{{ global_progress.completed|default:0 }}</span> / <span data-progress-total>{{ global_progress.total|default:0 }}</span> lecții finalizate</span>
            </div>
            {% if next_lesson %}
                <a class="btn btn-primary btn-lg lesson-next"
                   data-next-button
                   data-next-url="{% url 'estudy:lesson_detail' slug=next_lesson.slug %}"
                   data-next-enabled-class="btn-primary"
                   data-next-disabled-class="btn-outline-light"
                   href="{% if next_locked %}#{% else %}{% url 'estudy:lesson_detail' slug=next_lesson.slug %}{% endif %}"
                   {% if next_locked %}aria-disabled="true" data-locked="true"{% endif %}>
                    {% if next_locked %}<i class="fa-solid fa-lock me-2"></i>Lecția următoare{% else %}<i class="fa-solid fa-arrow-right me-2"></i>Continuă aventura{% endif %}
                </a>
            {% endif %}
        </aside>
    </header>

    <div class="lesson-layout">
        <div class="lesson-flow">
            <section class="lesson-block lesson-block--theory">
                <header class="lesson-block__header">
                    <span class="lesson-block__eyebrow">Teorie prietenoasă</span>
                    <h2 class="lesson-block__title">Ce descoperi în această lecție</h2>
                </header>
                <div class="lesson-block__body">
                    <p>Variabilele se comportă ca niște cutii digitale. Le poți denumi, umple cu informație și folosi ori de câte ori ai nevoie. Mai jos găsești pe scurt pașii esențiali și câteva idei vizuale care te ajută să reții mai repede.</p>
                    {% if enrichment.concept_cards %}
                        <div class="concept-deck">
                            {% for card in enrichment.concept_cards %}
                                <article class="concept-card">
                                    <div class="concept-card__emoji">{{ card.emoji }}</div>
                                    <h3 class="concept-card__title">{{ card.title }}</h3>
                                    <p class="concept-card__text">{{ card.description }}</p>
                                </article>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </section>

            {% if enrichment.story_steps %}
            <section class="lesson-block lesson-block--story">
                <header class="lesson-block__header">
                    <span class="lesson-block__eyebrow">Parcurge pașii</span>
                    <h2 class="lesson-block__title">Cum folosim variabilele în cod</h2>
                </header>
                <div class="lesson-block__body">
                    <ol class="lesson-story">
                        {% for step in enrichment.story_steps %}
                            <li class="lesson-story__item">
                                <div class="lesson-story__badge">{{ forloop.counter }}</div>
                                <div class="lesson-story__content">
                                    <h3 class="lesson-story__title">{{ step.title }}</h3>
                                    <p class="lesson-story__detail">{{ step.detail }}</p>
                                    {% if step.tip %}<p class="lesson-story__tip"><i class="fa-solid fa-wand-magic-sparkles me-1"></i>{{ step.tip }}</p>{% endif %}
                                </div>
                            </li>
                        {% endfor %}
                    </ol>
                </div>
            </section>
            {% endif %}

            <section class="lesson-block lesson-block--example">
                <header class="lesson-block__header">
                    <span class="lesson-block__eyebrow">Exemplu din viața reală</span>
                    <h2 class="lesson-block__title">Ține evidența hidratării</h2>
                </header>
                <div class="lesson-block__body">
                    {% if enrichment.real_example %}
                        <p>{{ enrichment.real_example }}</p>
                    {% else %}
                        <p>Imaginează-ți o aplicație care notează câte pahare cu apă bei într-o zi. Variabila ține scorul și îți spune când ai atins ținta de hidratare.</p>
                    {% endif %}
                    <ol class="lesson-example-list">
                        {% if enrichment.real_example_steps %}
                            {% for example_step in enrichment.real_example_steps %}
                                <li>{{ example_step }}</li>
                            {% endfor %}
                        {% else %}
                                <li>Setezi variabila <code>pahare</code> la 0 dimineața.</li>
                                <li>De fiecare dată când bei apă, actualizezi variabila prin <code>pahare = pahare + 1</code>.</li>
                                <li>Când <code>pahare</code> ajunge la 6, aplicația îți trimite un mesaj de felicitare.</li>
                        {% endif %}
                    </ol>
                </div>
            </section>

            {% if enrichment.code_challenges %}
            <section class="lesson-block lesson-block--code">
                <header class="lesson-block__header">
                    <span class="lesson-block__eyebrow">Provocări de cod</span>
                    <h2 class="lesson-block__title">Testează ce ai învățat</h2>
                </header>
                <div class="lesson-block__body">
                    <div class="code-challenge-grid">
                        {% for challenge in enrichment.code_challenges %}
                            <article class="code-challenge">
                                <div class="code-challenge__head">
                                    <h3 class="code-challenge__title">{{ challenge.title }}</h3>
                                    <span class="code-challenge__hint">Hint: {{ challenge.hint }}</span>
                                </div>
                                <p class="code-challenge__desc">{{ challenge.description }}</p>
                                <div class="code-editor-wrapper" data-code-challenge data-expected-keywords="{{ challenge.expected_keywords|join:',' }}">
                                    <textarea class="code-editor" rows="5">{{ challenge.starter }}</textarea>
                                    <div class="code-editor-actions">
                                        <button type="button" class="btn btn-soft code-check-btn"><i class="fa-solid fa-magnifying-glass me-1"></i>Verifică</button>
                                        <button type="button" class="btn btn-outline-primary code-reset-btn"><i class="fa-solid fa-rotate-left me-1"></i>Reia</button>
                                    </div>
                                    <div class="code-feedback small mt-2"></div>
                                    <div class="alert alert-success mt-3 d-none code-success"><i class="fa-solid fa-party-horn me-1"></i>Excelent! Ai folosit toate elementele esențiale.</div>
                                </div>
                            </article>
                        {% endfor %}
                    </div>
                </div>
            </section>
            {% endif %}

            <section class="lesson-block lesson-block--practice">
                <header class="lesson-block__header">
                    <span class="lesson-block__eyebrow">Exercițiu interactiv</span>
                    <h2 class="lesson-block__title">Potrivește conceptele corecte</h2>
                </header>
                <div class="lesson-block__body">
                    {% if practice and practice.has_pairs %}
                        <div class="lesson-practice" data-practice-station>
                            <div class="lesson-practice__head">
                                <p class="lesson-practice__intro">{{ practice.intro|default:"Trage etichetele corecte în zona potrivită pentru a reține mai ușor noțiunile." }}</p>
                                <button type="button" class="btn btn-soft practice-reset"><i class="fa-solid fa-arrows-rotate me-1"></i>Repornește</button>
                            </div>
                            {% if practice.instructions %}<p class="lesson-practice__hint">{{ practice.instructions }}</p>{% endif %}
                            <div class="row g-4 align-items-start">
                                <div class="col-lg-5">
                                    <div class="lesson-draggables" data-practice-source>
                                        {% for item in practice.data.draggables %}
                                            <div class="practice-chip" draggable="true" data-match="{{ item.id }}">
                                                <span>{{ item.label }}</span>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="col-lg-7">
                                    <div class="lesson-dropzones">
                                        {% for target in practice.data.targets %}
                                            <div class="practice-dropzone" data-accept="{{ target.accepts }}">
                                                <span class="practice-dropzone__prompt">{{ target.prompt }}</span>
                                                <div class="practice-dropzone__slot"></div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <p class="practice-feedback text-danger small mt-3 d-none"></p>
                            <div class="alert alert-success mt-4 d-none practice-success" role="alert">
                                <i class="fa-solid fa-party-horn me-2"></i>{{ practice.success_message|default:"Super! Ai potrivit corect toate conceptele." }}
                            </div>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">Exercițiul interactiv va apărea aici imediat ce este pregătit pentru această lecție.</p>
                    {% endif %}
                </div>
            </section>

            {% if tests %}
            <section class="lesson-block lesson-block--quiz">
                <header class="lesson-block__header">
                    <span class="lesson-block__eyebrow">Mini quiz</span>
                    <h2 class="lesson-block__title">Verifică-ți cunoștințele</h2>
                </header>
                <div class="lesson-block__body d-flex flex-column gap-4">
                    {% for test in tests %}
                        <article class="quiz-card" data-test-id="{{ test.id }}" data-submit-href="{% url 'estudy:submit_test_attempt' test_id=test.id %}">
                            <div class="quiz-card__head">
                                <div>
                                    <span class="badge bg-primary-subtle text-primary me-2">Întrebarea {{ forloop.counter }}</span>
                                    <span class="badge bg-info-subtle text-info">{{ test.get_difficulty_display|default:"Standard" }}</span>
                                </div>
                                <span class="badge bg-secondary-subtle text-secondary">{{ test.points }} puncte</span>
                            </div>
                            <p class="quiz-card__question">{{ test.question }}</p>
                            <form class="quiz-options">
                                {% for option in test.answer_choices %}
                                    <label class="quiz-option">
                                        <input type="radio" name="answer" value="{{ option }}">
                                        <span>{{ option }}</span>
                                    </label>
                                {% endfor %}
                                <div class="quiz-card__actions">
                                    <button type="submit" class="btn btn-primary btn-sm"><i class="fa-solid fa-paper-plane me-1"></i>Verifică</button>
                                    <span class="quiz-feedback small text-muted"></span>
                                </div>
                                {% if test.explanation %}
                                    <div class="quiz-explanation alert alert-info mt-3 d-none" role="alert"></div>
                                {% endif %}
                            </form>
                        </article>
                    {% endfor %}
                </div>
            </section>
            {% endif %}

            <nav class="lesson-nav">
                <div class="lesson-nav__group">
                    {% if prev_lesson %}
                        <a class="btn btn-outline-primary lesson-nav__btn" href="{% url 'estudy:lesson_detail' slug=prev_lesson.slug %}"><i class="fa-solid fa-arrow-left me-2"></i>Lecția anterioară</a>
                    {% endif %}
                    <a class="btn btn-outline-secondary lesson-nav__btn" href="{% url 'estudy:lessons_list' %}"><i class="fa-solid fa-list me-2"></i>Înapoi la lecții</a>
                </div>
                {% if next_lesson %}
                    <a class="btn btn-lg lesson-nav__btn {% if next_locked %}btn-outline-secondary disabled{% else %}btn-primary{% endif %}"
                       data-next-button
                       data-next-url="{% url 'estudy:lesson_detail' slug=next_lesson.slug %}"
                       data-next-enabled-class="btn-primary"
                       data-next-disabled-class="btn-outline-secondary"
                       href="{% if next_locked %}#{% else %}{% url 'estudy:lesson_detail' slug=next_lesson.slug %}{% endif %}"
                       {% if next_locked %}aria-disabled="true" data-locked="true"{% endif %}>
                        {% if next_locked %}<i class="fa-solid fa-lock me-2"></i>Lecția următoare{% else %}<i class="fa-solid fa-arrow-right me-2"></i>Lecția următoare{% endif %}
                    </a>
                {% endif %}
            </nav>
        </div>

        <aside class="lesson-sidebar">
            <section class="lesson-outline card shadow-sm">
                <div class="lesson-outline__header">
                    <h2 class="lesson-outline__title">Traseul lecțiilor</h2>
                    <p class="lesson-outline__subtitle">Parcurge pas cu pas și deblochează următoarea etapă.</p>
                </div>
                <ol class="lesson-outline__list">
                    {% for step in subject_sequence %}
                        <li class="lesson-outline__item {% if step.completed %}is-done{% elif step.is_current %}is-current{% elif not step.accessible %}is-locked{% endif %}" data-sequence-step data-locked="{% if not step.accessible and not step.completed %}true{% else %}false{% endif %}">
                            <div class="lesson-outline__bubble">{{ step.index }}</div>
                            <div class="lesson-outline__content">
                                <div class="lesson-outline__name">{{ step.lesson.title }}</div>
                                <div class="lesson-outline__meta">{{ step.lesson.subject.name }}</div>
                                {% if step.locked_reason and not step.accessible and not step.completed %}
                                    <p class="lesson-outline__hint"><i class="fa-solid fa-lock me-1"></i>Finalizează „{{ step.locked_reason.title }}” pentru a continua.</p>
                                {% endif %}
                            </div>
                            {% if step.accessible or step.completed %}
                                <a class="lesson-outline__link" href="{% url 'estudy:lesson_detail' slug=step.lesson.slug %}"><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                            {% else %}
                                <span class="lesson-outline__locked"><i class="fa-solid fa-lock"></i></span>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ol>
            </section>

            {% if recommendations %}
            <section class="lesson-sidebar-card card shadow-sm">
                <div class="lesson-sidebar-card__header">
                    <h2 class="lesson-sidebar-card__title">Continuă cu</h2>
                    <p class="lesson-sidebar-card__subtitle">Lecții recomandate pentru tine</p>
                </div>
                <div class="lesson-sidebar-card__body">
                    <ul class="lesson-sidebar-list">
                        {% for item in recommendations|slice:':3' %}
                            <li class="lesson-sidebar-list__item">
                                <div>
                                    <div class="lesson-sidebar-list__name">{{ item.lesson.title }}</div>
                                    <span class="lesson-sidebar-list__meta">{{ item.lesson.subject.name }}</span>
                                </div>
                                <a class="btn btn-sm btn-outline-primary" href="{% url 'estudy:lesson_detail' slug=item.lesson.slug %}">Start</a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </section>
            {% endif %}
        </aside>
    </div>
</div>
{% endblock %}
